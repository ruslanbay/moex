<!DOCTYPE html>
<html lang="en">

<head>
  <base href="https://ruslanbay.github.io/">
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>MOEX Capitalization</title>
  <link rel="icon" href="/moex/images/icons/favicon.ico" type="image/x-icon">
  <link rel="manifest" href="/moex/manifest.json">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black">
  <meta name="apple-mobile-web-app-title" content="MOEX Capitalization">
  <link rel="apple-touch-icon" href="/moex/images/icons/icon-152x152.png">
  <meta name="description" content="Russian Stock Market Visualization. How the Russian stock market has changed over the past 20+ years">
  <style>
    html,
    body {
      overflow: hidden;
      position: relative;
      width: 99.5%;
      height: 100%;
      background-color: rgb(65, 69, 84);
    }

    header {
      height: 45px;
      padding: 0;
      margin: 0;
      background-color: rgb(65, 69, 84);
      border: 0px;
      border-color: rgb(65, 69, 84);
      color: #ffffff;
      position: absolute;
      top: 0px;
      right: 0px;
      outline: none;
      display: flex;
      align-items: center;
    }

    a:link,
    a:visited,
    a:hover,
    a:active {
      color: #ffffff;
      text-decoration: none;
    }

    * {
      -webkit-touch-callout: none;
      -webkit-user-select: none;
      -khtml-user-select: none;
      -moz-user-select: none;
      -ms-user-select: none;
      user-select: none;
    }

    #chart {
      height: 91%;
      width: 100%;
      overflow: hidden;
      background-color: rgb(65, 69, 84);
      position: absolute;
      top: 45px;
      left: 0px;
      outline: none;
    }
  </style>
  <script src='https://cdn.jsdelivr.net/npm/jquery/dist/jquery.min.js'></script>
  <script src='https://cdn.jsdelivr.net/npm/plotly.js/dist/plotly.min.js'></script>
  <script src='https://cdn.jsdelivr.net/npm/d3/dist/d3.min.js'></script>
  <script type="text/javascript">
    document.addEventListener('contextmenu', event => event.preventDefault()); // TODO: customize context menu
  </script>
</head>

<body>
  <header>
    <select id="currencySelector">
      <option value="USD" selected="selected">USD</option>
      <option value="EUR">EUR</option>
      <option value="CNY">CNY</option>
      <option value="RUB">RUB</option>
    </select>
    &nbsp;&nbsp;
    <a href="https://github.com/ruslanbay" title="GitHub">
      <img src="/moex/images/icons/github.svg" height="30" />&nbsp;&nbsp;
    </a>
    <a href="https://www.linkedin.com/in/ruslanbay" title="Linkedin">
      <img src="/moex/images/icons/linkedin.svg" height="30" />&nbsp;&nbsp;
    </a>
    <a href="/moex/" title="MOEX Capitalization">
      <img src="/moex/images/icons/treemap.jpeg" height="40" style="outline: 3px solid white; outline-offset: -4px;" />
    </a>
    <a href="/moex/history" title="MOEX History">
      <img src="/moex/images/icons/scatter.jpeg" height="40" style="outline: 3px solid white; outline-offset: -4px;" />
    </a>
    <a href="/moex/listings" title="MOEX Listings">
      <img src="/moex/images/icons/bar.jpeg" height="40" style="outline: 3px solid white; outline-offset: -4px;" />
    </a>
    &nbsp;
  </header>

  <div id='chart'></div>
  <script>
    function generateDateRange(startDate) {
      const dates = [];
      const endDate = new Date();
      const currentDate = new Date(startDate);
      while (currentDate <= endDate) {
        const formattedDate = currentDate.toISOString().split('T')[0];
        dates.push(formattedDate);
        currentDate.setDate(currentDate.getDate() + 7);
      }
      return dates;
    }
  </script>
  <script type="text/javascript">

    async function prepChartData(currency) {
      try {
        const chartData = {};
        const startDate = '2011-12-19';

        var response = await fetch('/moex/data/issues-by-sector.tsv');
        response = await response.text();
        var data = response.split('\n')
          .slice(1, 37)
          .map(row => row.split('\t'));
        const traceColors = {};
        data.forEach(row => {
          const [, label, , , , , , traceColor] = row;
          traceColors[label] = traceColor;
        });


        response = await fetch(`/moex/history/${currency}FIXME.csv`);
        response = await response.text();
        data = response.split('\n')
          .map(row => row.split(','));
        const currencyRates = {};
        data.forEach(row => {
          const [Date, , , , Close] = row;
          if (Date >= startDate) {
            currencyRates[Date] = Number(Close);
          }
        });

        const oneOverY = Object.values(currencyRates);

        if (!chartData[currency]) {
          chartData[currency] = {
            name: currency,
            customdata: oneOverY,
            type: "scatter",
            mode: "lines",
            yaxis: "y2",
            hoverinfo: "all",
            hovertemplate: "%{x|%x}<br>%{customdata:,.2f}<br>RUB per %{fullData.name}<extra></extra>",
            x: Object.keys(currencyRates),
            y: Object.values(currencyRates).map(y => y > 0 ? 1 / y : null)
          };
        }

        response = await fetch(`https://raw.githubusercontent.com/datasets/oil-prices/refs/heads/main/data/brent-daily.csv`);
        response = await response.text();
        data = response.split('\n')
          .map(row => row.split(','));
        const brentRates = {};
        data.forEach(row => {
          const [Date, Close] = row;
          if (Date >= startDate) {
            brentRates[Date] = Number(Close);
          }
        });

        if (!chartData['brent']) {
          chartData['brent'] = {
            name: 'Brent',
            type: "line",
            mode: "lines",
            yaxis: "y3",
            hoverinfo: "all",
            hovertemplate: "%{x|%x}<br>%{y:,.2f}<br>USD per %{fullData.name}<extra></extra>",
            x: Object.keys(brentRates),
            y: Object.values(brentRates)
          };
        }

        const rows = await d3.csv(`/moex/history/total.csv`);

        rows.forEach(row => {
          const traceName = row.traceName;
          const traceNameExcludeList = ['TQFD. PAI (USD)', 'TQIF. PAI', 'TQPI. Shares PIR', 'TQTF. ETF', 'TQTY. PAI (CNY)',
                                        'cb_bond', 'corporate_bond', 'etf_ppif', 'euro_bond', 'exchange_bond', 'exchange_ppif',
                                        'Foreign Companies', 'ifi_bond', 'interval_ppif', 'municipal_bond', 'ofz_bond',
                                        'private_ppif', 'public_ppif', 'state_bond', 'stock_mortgage', 'subfederal_bond'];
          const date = row.date;
          var marketCap = parseFloat(row.marketCap);
          if (traceNameExcludeList.includes(traceName)) {
            return;
          }

          if (!chartData[traceName]) {
            chartData[traceName] = {
              name: traceName,
              type: "scatter",
              mode: "lines",
              stackgroup: "one",
              hoverinfo: "all",
              hovertemplate: "%{x|%x}<br>%{y:,.0f}<br>%{fullData.name}<extra></extra>",
              marker: {
                color: traceColors[traceName]
              },
              x: [],
              y: []
            };
          }

          if (currency !== 'RUB') {
            if (currencyRates[date] !== undefined) {
              rate = currencyRates[date];
            }
            marketCap = marketCap / rate;
          }

          chartData[traceName].x.push(date);
          chartData[traceName].y.push(marketCap);
        });
      
        const jsonChartData = Object.values(chartData);
        return jsonChartData;

      } catch (error) {
        console.error('Error fetching data:', error);
        throw error;
      }
    };

    function refreshChart() {
      var currency = document.getElementById('currencySelector').value;

      prepChartData(currency)
        .then(function(chartData) {
          var layout = {
            annotations: [{
              name: 'wm',
              text: '<a style="color: grey;" href="https://ruslanbay.github.io/moex">ruslanbay.github.io/moex</a><br><a style="color: grey;" href="https://www.linkedin.com/in/ruslanbay">linkedin.com/in/ruslanbay</a><br><a style="color: grey;" href="https://github.com/ruslanbay">github.com/ruslanbay</a>',
              xref: 'paper',
              yref: 'paper',
              x: 0.03,
              y: 0.03,
              showarrow: false,
              opacity: 0.9,
              align: 'left',
              font: {
                size: 16,
                color: 'rgb(120, 108, 144)'
              }
            }],
            showlegend: true,
            legend: {
              visible: true,
              traceorder: "normal",
              orientation: "h",
              x: 0,
              xanchor: "left",
              y: 0.89,
              yanchor: "bottom",
              // entrywidth: 0,
              bgcolor: 'rgba(0, 0, 0, 0)',
              bordercolor: 'rgba(0, 0, 0, 0)',
              borderwidth: 0,
            },
            yaxis: {
              visible: true,
              fixedrange: true,
              side: "right",
              showgrid: true,
            },
            yaxis2: {
              title: 'Currency Rate',
              overlaying: 'y',
              visible: false,
              fixedrange: true,
              side: 'left',
            },
            yaxis3: {
              title: 'Oil prices',
              overlaying: 'y',
              visible: false,
              fixedrange: true,
              side: 'left',
            },
            xaxis: {
              type: "date",
              fixedrange: false,
              // tickangle: -35,
              tickformatstops: [
                enabled = false,
                {
                  dtickrange: [null, 'M1'],
                  value: '%e %b\n%Y'
                },
                {
                  dtickrange: ['M1', 'M12'],
                  value: '%b\n%Y'
                },
                {
                  dtickrange: ['M12', null],
                  value: '%Y'
                }
              ],
              rangeslider: {
                visible: true,
              },
              rangeselector: {
                visible: true,
                activecolor: "#000000",
                bgcolor: "rgb(38, 38, 39)",
                buttons: [{
                  step: 'month',
                  stepmode: 'backward',
                  count: 1,
                  label: '1m'
                }, {
                  step: 'month',
                  stepmode: 'backward',
                  count: 6,
                  label: '6m'
                }, {
                  step: 'year',
                  stepmode: 'todate',
                  count: 1,
                  label: 'YTD'
                }, {
                  step: 'year',
                  stepmode: 'backward',
                  count: 1,
                  label: '1y'
                }, {
                  step: 'all',
                }]
              }
            },
            autosize: true,
            margin: {
              l: 0,
              r: 30,
              t: 0,
              b: 0
            },
            plot_bgcolor: "rgb(65, 69, 84)",
            paper_bgcolor: "rgb(65, 69, 85)",
            font: {
              family: "Arial",
              size: 12,
              color: "rgba(245, 246, 249, 1)"
            }
          }

          var config = {
            responsive: true,
            displaylogo: false,
            displayModeBar: true,
            scrollZoom: true
          }
          Plotly.react('chart', chartData, layout, config);
        })
        .catch(function(error) {
          console.error(error);
        });
    }

    const inputCurrencySelector = document.getElementById("currencySelector");
    inputCurrencySelector.addEventListener("change", refreshChart);

    refreshChart();
  </script>
</body>

</html>
