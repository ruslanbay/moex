<!-- 
  Для всех акций из списка data.tsv получить значение history_from из ISSUEDATE на странице https://iss.moex.com/iss/securities/AFKS.json
  Это требуется, тк для многих акций в поле history_from указана дата "2014-06-09", что не соответствует действительности
  Возможно, нет записей о стоимости акций за период до 2014-06-09, в этом случае может добавить отдельное поле ISSUEDATE????
-->

<!-- 
  В файл data.tsv добавить поле "emitent"
  https://iss.moex.com/iss/securities?engine=stock&market=shares&group_by=group&group_by_filter=stock_shares&securities.columns=secid,shortname,name,emitent_title&start=0
  parents || emitent || labels || shortname || shortname_rus || name_rus || history_from || history_till
  Это нужно, чтобы объединять обычные и привилегированные акции одного и того же эмитента.
  Так же упростит подсчёт капитализации эмитента.
  Площадь квадрата Эмитента можно брать из данных о капитализации компании, а если значение больше суммы стоимости акций, то добавить внутри доп. квадрат с подписью "другие активы"
-->

<!-- 
  0. !!! РАЗ В ДЕНЬ ОБНОВЛЯТЬ СОДЕРЖИМОЕ ФАЙЛА data.tsv
  0.0. Переходим на страницу https://iss.moex.com/iss/history/engines/stock/markets/shares/boards/TQBR/listing?status=all
  0.1. Находим все акции, которые перестали торговаться на Мосбирже, т.е. ДАТА ПРЕДЫДУЩЕЙ ПРОВЕРКИ <= history_till <= ТЕКУЩАЯ ДАТА
  0.2. Находим все новые акции, т.е. ДАТА ПРЕДЫДУЩЕЙ ПРОВЕРКИ <= history_from
  0.3. Название компании латиницей получаем из https://iss.moex.com/iss/securities/AFKS
  1. Пользователь передаёт ДАТУ, за которую нужно построить график
  2  Из файла data.tsv получаем список secid для акций, у которых history_from <= ДАТА <= history_till
  3. Переходим на страницу https://iss.moex.com/iss/history/engines/stock/totals/boards/MRKT/securities.json?iss.meta=off&from=2023-07-19&till=2023-07-19&securities.columns=SECID,CURRENCYID,OPEN,CLOSE,VOLUME,VALUE,NUMTRADES,DAILYCAPITALIZATION
  4. Получаем данные о стоиммости акции, об изменении стоимости и капитализации
  5. Мержим полученные данные в один JS Object и строим для него тримап
 -->
<head>
    <style>
    html, body {
      overflow: hidden;
      position: relative;
      width: 100%;
      height: 100%;
      background-color: rgb(65,69,84);
    }
    * {
      -webkit-touch-callout: none;
      -webkit-user-select: none;
      -khtml-user-select: none;
      -moz-user-select: none;
      -ms-user-select: none;
      user-select: none;
    }
    main,
    section,
    #myDiv,
    .page-content {
      height: 100%;
      overflow: hidden;
      background-color: rgb(65,69,84);
    }
    </style>
    
    <script src='https://cdn.plot.ly/plotly-2.24.1.min.js'></script>

    <!--
    Работает только с версией D3 4.13.0 и ниже,
    так как начиная с версии 5.0.0 используются Promises
    https://github.com/d3/d3/blob/main/CHANGES.md#changes-in-d3-50
    -->
    <script src='https://code.jquery.com/jquery-3.7.0.min.js'></script>
    <script src='https://cdnjs.cloudflare.com/ajax/libs/d3/4.13.0/d3.min.js'></script>
    <script>
        d3.tsv('https://raw.githubusercontent.com/ruslanbay/moex/main/data.tsv?token=GHSAT0AAAAAACFQI5QZIFLRVPKQRAOLN4Z2ZF7YFHQ', function(err, rows){
            function unpack(rows, key) {
                return rows.map(function(row) { return row[key]});
            }

            var chartData = {};
            chartData["sector"] = [];
            chartData["ticker"] = [];
            chartData["size"] = [];
            chartData["priceChange"] = [];
            chartData["customdata"] = [];

            var labels = unpack(rows, 'labels');
            var parents = unpack(rows, 'parents');
            var shortnames = unpack(rows, 'shortname');
            var shortnamesRus = unpack(rows, 'shortname_rus');
            var namesRus = unpack(rows, 'name_rus');

            for (let i=0; i<=14; i++) {
              chartData["sector"].push(parents[i]);
              chartData["ticker"].push(labels[i]);
            };

            $.getJSON( "https://iss.moex.com/iss/history/engines/stock/totals/boards/MRKT/securities.json?iss.meta=off&from=2023-07-19&till=2023-07-19&securities.columns=SECID,CURRENCYID,OPEN,CLOSE,VOLUME,VALUE,NUMTRADES,DAILYCAPITALIZATION", function( moexJson ) {
              moexJson.securities.data.forEach(item => {
                var ticker = item[0];
                var currency = item[1];
                var openPrice = item[2];
                var closePrice = item[3];
                var volume = item[4];
                var value = item[5];
                var numTrades = item[6];
                var marketCapDaily = item[7];
                
                var sector = "Others";

                var index = labels.indexOf(ticker);
                // if (index != -1) {
                //   sector = parents[index];
                // }
                var name = namesRus[index];
                var priceChange = (closePrice - openPrice)/openPrice;
                
                chartData["sector"].push(sector);
                chartData["ticker"].push(ticker);
                chartData["size"].push(1);
                chartData["priceChange"].push(1);
                // chartData["customdata"].push([sector, ticker, marketCapDaily, priceChange, name, closePrice]);
                chartData["customdata"].push(["Others", "ticker", 1, 1, "name", 1]);
              })
            });

            console.log(chartData);
            console.log(chartData["sector"]);
            console.log(chartData["ticker"]);
            
            var texttemplate = '<b>%{label}</b><br>%{customdata[4]}<br>%{customdata[5]:,.2f} (%{customdata[3]:.2f}%)<br>Mkt cap: %{value:$,.0f}';
            var hovertemplate = '<b>%{customdata[1]}</b><br>%{customdata[4]}<br>Share price: %{customdata[5]:,.4f}<br>Price change: %{customdata[3]:.2f}%<br>Mkt cap: %{customdata[2]:$,.0f}<br>percentParent: %{percentParent:.2p}<br>percentRoot: %{percentRoot:.2p}<extra></extra>';
            
            var data = [{
                type: "treemap",
                // ids: labels,
                labels: chartData["ticker"],
                parents: chartData["sector"],
                values: chartData["size"],
                marker: {
                      colors: chartData.priceChange,
                      colorscale: [[0, 'rgb(246,53,56)'], [0.5, 'rgb(65,69,84)'], [1, 'rgb(48,204,90)']],
                      cmin: -3,
                      cmid: 0,
                      cmax: 3,
                      line: {width: 2, color: "rgb(64,68,83)"}
                    },
                    text: 'chartData.customdata[4]',
                    textinfo: "label+text+value",
                    customdata: chartData.customdata,
                    branchvalues: 'total',
                    texttemplate: texttemplate,
                    hovertemplate: hovertemplate,
                    pathbar: {visible: true}
            }];

            var layout = {
                showlegend: false,
                autosize: true,
                margin: {l:0, r:0, t:45, b:0},
                paper_bgcolor: "rgb(0,0,0,0)",
                plot_bgcolor: "rgb(0,0,0,0)"
              }
            
            var config = {
              responsive: true,
              displaylogo: false,
              displayModeBar: false,
              scrollZoom: true
            }
            Plotly.react('myDiv', data, layout, config);
        })
    </script>
</head>

<body>
    <div id='myDiv'><!-- Plotly chart will be drawn inside this DIV --></div>
</body>
