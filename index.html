<!-- 
  1. От пользователя получаем ДАТУ, за которую нужно построить график
  2.1. Переходим на страницу https://iss.moex.com/iss/history/engines/stock/markets/shares/boards/TQBR/listing?status=all
  2.2. На одной странице получаем по 100 записей
  2.3. Передаём параметр start=100, чтобы получить следующую сотню
  2.4. Если в json менее 100 записей, значит это последняя страница
  2.5. Мы получили все записи.
  3. Получаем список secid для акций, у которых history_from <= ДАТА <= history_till
  4. Для каждой акции из списка находим соответствующую отрасль из файла data.tsv
  5. Если отрасль не найдена, то присваиваем отрасль Прочее/Other
  6. Переходим на страницу https://iss.moex.com/iss/history/engines/stock/totals/boards/MRKT/securities.json?iss.meta=off&from=2023-07-19&till=2023-07-19&securities.columns=SECID,CURRENCYID,OPEN,CLOSE,VOLUME,VALUE,NUMTRADES,DAILYCAPITALIZATION
  7. Получаем данные о стоиммости акции, об изменении стоимости и капитализации
  8. Мержим полученные данные в один JS Object и строим для него тримап
 -->
<head>
    <style>
    html, body {
      overflow: hidden;
      position: relative;
      width: 100%;
      height: 100%;
      background-color: rgb(65,69,84);
    }
    * {
      -webkit-touch-callout: none;
      -webkit-user-select: none;
      -khtml-user-select: none;
      -moz-user-select: none;
      -ms-user-select: none;
      user-select: none;
    }
    main,
    section,
    #myDiv,
    .page-content {
      height: 100%;
      overflow: hidden;
      background-color: rgb(65,69,84);
    }
    </style>
    
    <script src='https://cdn.plot.ly/plotly-2.24.1.min.js'></script>

    <!--
    Работает только с версией D3 4.13.0 и ниже,
    так как начиная с версии 5.0.0 используются Promises
    https://github.com/d3/d3/blob/main/CHANGES.md#changes-in-d3-50
    -->
    <script src='https://cdnjs.cloudflare.com/ajax/libs/d3/4.13.0/d3.min.js'></script>
    <script>
        d3.tsv('https://raw.githubusercontent.com/ruslanbay/moex/main/data.tsv?token=GHSAT0AAAAAACFJAPFEI5FZJLDI6TFM5GRWZFYADGA', function(err, rows){
            function unpack(rows, key) {
                return rows.map(function(row) { return row[key]});
            }

            var texttemplate = '<b>%{label}</b><br>%{customdata[4]}<br>%{customdata[5]:,.2f} (%{customdata[3]:.2f}%)<br>Mkt cap: %{value:$,.0f}';
            var hovertemplate = '<b>%{customdata[1]}</b><br>%{customdata[4]}<br>Share price: %{customdata[5]:,.4f}<br>Price change: %{customdata[3]:.2f}%<br>Mkt cap: %{customdata[2]:$,.0f}<br>percentParent: %{percentParent:.2p}<br>percentRoot: %{percentRoot:.2p}<extra></extra>';
            
            var data = [{
                type: "treemap",
                // ids: unpack(rows, 'labels'),
                labels: unpack(rows, 'labels'),
                parents: unpack(rows, 'parents'),
                // values: ???,
                marker: {
                      // colors: chartData.priceChange,
                      colorscale: [[0, 'rgb(246,53,56)'], [0.5, 'rgb(65,69,84)'], [1, 'rgb(48,204,90)']],
                      cmin: -3,
                      cmid: 0,
                      cmax: 3,
                      line: {width: 2, color: "rgb(64,68,83)"}
                    },
                    // text: 'chartData.customdata[4]',
                    textinfo: "label+text+value",
                    // customdata: chartData.customdata,
                    branchvalues: 'total',
                    texttemplate: texttemplate,
                    hovertemplate: hovertemplate,
                    pathbar: {visible: true}
            }];

            var layout = {
                showlegend: false,
                autosize: true,
                margin: {l:0, r:0, t:45, b:0},
                paper_bgcolor: "rgb(0,0,0,0)",
                plot_bgcolor: "rgb(0,0,0,0)"
              }
            
            var config = {
              responsive: true,
              displaylogo: false,
              displayModeBar: false,
              scrollZoom: true
            }
            Plotly.react('myDiv', data, layout, config);
        })
    </script>
</head>

<body>
    <div id='myDiv'><!-- Plotly chart will be drawn inside this DIV --></div>
</body>
